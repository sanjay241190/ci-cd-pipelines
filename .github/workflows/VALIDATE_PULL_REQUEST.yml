name: VALIDATE PULL REQUEST

on:
  repository_dispatch:
    types: [sf-pr-created]

jobs:
  validate:
    runs-on: ubuntu-latest

    container:
      image: sanjaxsf/prulife-sf:latest
      credentials:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    steps:
      - name: Extract PR Metadata
        run: |
          echo "PR Number: ${{ github.event.client_payload.pr_number }}"
          echo "Source Branch: ${{ github.event.client_payload.source_branch }}"
          echo "Target Branch: ${{ github.event.client_payload.target_branch }}"

      - name: Checkout SalesforcePrulifePOC Repo
        uses: actions/checkout@v4
        with:
          repository: sanjay241190/SalesforcePrulifePOC
          ref: ${{ github.event.client_payload.source_branch }}
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Environment Sanity Check
        run: |
          echo "Checking installed tools..."
          sf --version
          sf plugins
          ant -version
          node -v
          pmd --version || echo "PMD version check skipped"

      - name: Fix Git Safe Directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE


      - name: Fetch Target Branch
        run: |
          git fetch origin ${{ github.event.client_payload.target_branch }}

      - name: Compute Merge Base
        id: mergebase
        run: |
          MERGE_BASE=$(git merge-base HEAD origin/${{ github.event.client_payload.target_branch }})
          echo "merge_base=$MERGE_BASE" >> $GITHUB_OUTPUT
          echo "Merge Base: $MERGE_BASE"

      - name: Install Required SF Plugins
        run: |
          sf plugins install sfdx-git-delta --force
          sf plugins install @salesforce/sfdx-scanner --force

      - name: Debug Installed Plugins
        run: |
          sf plugins
          sf commands | grep delta || true

      - name: Generate Delta Package
        run: |
          mkdir force-app-delta
          sf sgd:source:delta \
            --to HEAD \
            --from ${{ steps.mergebase.outputs.merge_base }} \
            --output-dir force-app-delta \
            --source-dir force-app
      
      - name: Show Delta Structure
        run: |
          ls -R force-app-delta || echo "No delta generated"



