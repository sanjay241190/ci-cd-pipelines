name: VALIDATE PULL REQUEST (Reusable)

on:
  workflow_call:
    inputs:
      source_branch:
        required: true
        type: string
      target_branch:
        required: true
        type: string
    secrets:
      GH_PAT:
        required: true
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true

jobs:
  validate:
    if: contains(fromJson('["main","uat","dev"]'), inputs.target_branch)
    runs-on: ubuntu-latest

    container:
      image: sanjaxsf/prulife-sf:1.0.3
      options: --pull always
      credentials:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    steps:

      - name: Display PR Info
        run: |
          echo "Source Branch: ${{ inputs.source_branch }}"
          echo "Target Branch: ${{ inputs.target_branch }}"
          
      - name: Validate Target Branch
        run: |
          if ! grep -qx "${{ inputs.target_branch }}" config/branches.txt; then
            echo "Branch '${{ inputs.target_branch }}' is NOT allowed."
            echo "Skipping pipeline execution."
            exit 0
          fi
          echo "Branch allowed. Continuing..."
          
      - name: Checkout Salesforce Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 0

      - name: Environment Sanity Check
        run: |
          echo "Checking installed tools..."
          sf --version
          sf plugins
          ant -version
          node -v
          pmd --version || echo "PMD version check skipped"

      - name: Fix Git Safe Directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Fetch Target Branch
        run: git fetch origin ${{ inputs.target_branch }}

      - name: Compute Merge Base
        id: mergebase
        run: |
          MERGE_BASE=$(git merge-base HEAD origin/${{ inputs.target_branch }})
          echo "merge_base=$MERGE_BASE" >> $GITHUB_OUTPUT
          echo "Merge Base: $MERGE_BASE"

      - name: Verify SF CLI & Plugins
        run: |
          sf version
          sf plugins

      - name: Generate Delta Package
        run: |
          mkdir force-app-delta
          sf sgd:source:delta \
            --to HEAD \
            --from ${{ steps.mergebase.outputs.merge_base }} \
            --output-dir force-app-delta \
            --source-dir force-app

      - name: Show Delta Structure
        run: |
          ls -R force-app-delta || echo "No delta generated"

      - name: Print Generated package.xml
        run: |
          if [ -f force-app-delta/package/package.xml ]; then
            echo "================ PACKAGE.XML ================"
            cat force-app-delta/package/package.xml
            echo "============================================="
          else
            echo "No package.xml generated"
          fi

      - name: Print Generated destructiveChanges.xml
        run: |
          if [ -f force-app-delta/destructiveChanges/destructiveChanges.xml ]; then
            echo "========== DESTRUCTIVE CHANGES XML =========="
            cat force-app-delta/destructiveChanges/destructiveChanges.xml
            echo "============================================="
          else
            echo "No destructiveChanges.xml generated"
          fi
          
      - name: Resolve Environment From Branch
        id: resolve_env
        run: |
          case "${{ inputs.target_branch }}" in            
            dev)       ENV_NAME="SANDEV" ;;
            uat)       ENV_NAME="SANUAT" ;;
            *)
              echo "Unknown branch mapping."
              exit 1
              ;;
          esac

          echo "Resolved Environment: $ENV_NAME"
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT

      - name: Authenticate to DEV Org
        if: steps.resolve_env.outputs.env_name == 'SANDEV'
        run: |
          echo "${{ secrets.SF_AUTH_URL_DEV }}" > token.txt
          sf auth sfdxurl store -f token.txt -a myOrg -s
          rm token.txt

      - name: Authenticate to UAT Org
        if: steps.resolve_env.outputs.env_name == 'SANUAT'
        run: |
          echo "${{ secrets.SF_AUTH_URL_UAT }}" > token.txt
          sf auth sfdxurl store -f token.txt -a myOrg -s
          rm token.txt

      - name: Verify Auth
        run: |
          sf org list
      
